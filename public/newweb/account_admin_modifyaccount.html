<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/common.js"></script>
    <link rel="stylesheet" type="text/css" href="css/new_main.css">
    <link href="plugin/left_nav/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="plugin/left_nav/css/style.css" media="screen" type="text/css"/>
    <script src="plugin/left_nav/js/index.js"></script>
    <script src="plugin/tab_plugin/jquery.hashchange.min.js" type="text/javascript"></script>
    <script src="plugin/tab_plugin/jquery.easytabs.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="plugin/tab_plugin/tab_style.css">
    <title>账户管理>编辑账户</title>
</head>

<body>
<div id="top">
    <div id="navbar-top">
        <div id="navbar-top-left" class="university-name">
            大学
        </div>
        <div id="navbar-top-right">
            <p class="logout"><span><i class="fa fa-power-off" style="margin-right:8px;"></i>退出登录</span></p>

            <p class="user_info"> 您好，<span class="user-name">admin</span> <span>2015-08-24  17:02</span></p>
        </div>
    </div>
</div>
<div id="left">
    <ul id="accordion" class="accordion">
        <li>
            <a href="first_page.html" class="left_nav_first">
                <div class="link"><i class="fa fa-home"></i>首页</div>
            </a>
        </li>
        <li>
            <div class="link"><i class="fa fa-bar-chart"></i>成绩管理<i class="fa fa-chevron-down"></i></div>
            <ul class="submenu">
                <li><a href="scoreadmin_preview.html">成绩总览</a></li>
                <li><a href="student_score_list.html">同学成绩列表</a></li>
            </ul>
        </li>
        <li>
            <div class="link"><i class="fa fa-database"></i>测试管理<i class="fa fa-chevron-down"></i></div>
            <ul class="submenu">
                <li><a href="#">查看测试</a></li>
                <li><a href="#">布置测试</a></li>
                <li><a href="#">学生测试列表</a></li>
                <li><a href="#">分组管理</a></li>
            </ul>
        </li>
        <li>
            <a href="class_admin.html" class="left_nav_first" id="left_nav4">
                <div class="link"><i class="fa fa-child"></i>班级管理</div>
            </a>
        </li>
        <li>
            <a href="teacher_admin.html" class="left_nav_first" id="left_nav5">
                <div class="link"><i class="fa fa-user"></i>教师管理</div>
            </a>
        </li>
        <li>
            <a href="system_construction.html" class="left_nav_first" id="left_nav6">
                <div class="link"><i class="fa fa-sitemap"></i>体系建设</div>
            </a>
        </li>
        <li>
            <a href="account_admin.html" class="left_nav_first" id="left_nav7">
                <div class="link"><i class="fa fa-cog"></i>账户管理</div>
            </a>
        </li>
    </ul>
</div>
<div id="mainbody">
    <div class="mainbody_title_box">账户管理>编辑账户</div>
    <div class="mainbody_bottom" style="border:none">
        <div class='tab-container'>
            <div class='panel-container'>
                <p style="font-size:24px; margin: -36px 0 20px 0;" class="font_color_black">请修改如下信息：</p>

                <form action="#">
                    <div class="main_bottom_graybox">
                        <p><span class="info_tittle">教师真实姓名：</span><input type="text"
                                                                          class="teacher_name cap_input block_bcolor_gray border_color_gray"
                                                                          name="s_realname"/></p>

                        <div class='system_choose'>
                            <p>
                                <span class="info_tittle">负责组织：</span>
                                <!--                                 <div id="select_1" data-id="1" style="display:inline-block" class="select_system">
                                                                    <select name="category_1" id="category_1" onChange="change('category_1');" class="cap_select block_bcolor_gray system_1" style="font-size:18px; border-color:#cfcfcf;">
                                                                        <option value="">请选择</option>
                                                                    </select>

                                                                </div> -->


                                <button type="button" class="orange_btn add_system">添加更多层级</button>
                            </p>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <button type="button" class="square_orange_btn modify_manager" style="font-size:18px;">修改
                        </button>
                        <button type="reset" class="square_orange_btn cancel" style="font-size:18px;">取消</button>
                    </div>
                </form>

                <form action="#">
                    <div class="main_bottom_graybox" style="margin-top:100px;">
                        <p><span class="info_tittle">修改密码：</span><input name="password" type="password"
                                                                        class="cap_input block_bcolor_gray border_color_gray"/>
                        </p>
                    </div>
                    <div style="text-align:right">
                        <button type="button" class="square_orange_btn modify_manager_password" style="font-size:18px;">
                            修改
                        </button>
                        <button type="reset" class="square_orange_btn cancel" style="font-size:18px;">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="footer">
    泸州市金点教育科技有限公司 All Rights Resserved
</div>

</body>
<script type="text/javascript">
    $("#left_nav7").find('div').css({color: '#b63b4d',}).find('i').css({color: '#b63b4d',});
    // 左侧导航 只有一层的 点击事件 颜色变化
    $(".left_nav_first").click(function (event) {
        $(".left_nav_first").find('div').css({color: '#4D4D4D',}).find('i').css({color: '#4D4D4D',});
        $(this).find('div').css({color: '#b63b4d',}).find('i').css({color: '#b63b4d',});
    });

    // 左侧导航 有两层的 点击事件 颜色变化
    $(".submenu a").click(function (event) {
        $(".submenu a").removeClass('bcolor');
        $(this).addClass('bcolor');
    });

    $(document).ready(function () {
        $('#tab-container').easytabs();

    });

    line_color_change();
    //表格列的颜色 交替显示
    function line_color_change() {
        var obj = $("tr");
        obj.each(function (index, el) {
            if (parseInt(index) % 2 != 0) {
                $(this).addClass('bg_white');
            }
        });
    }

    $(function () {
        getLeftBar();
        getTop();
        var s_m_id = getUrlParam('s_m_id');
        getManagerInfo(s_m_id);
        clickAddNewSystem();
        clickDelSystem();
        cancelModify();
        modifyManager(s_m_id);
        modifyManagerPassword(s_m_id);

    });

    function getTop() {
        $('.logout').click(function () {
            window.location.href = '/school_login/school_logout';
        });
        $('.university-name').html(getCookie('university_name'));
        $('.user-name').html(getCookie('user_name'));
    }

    function getLeftBar() {
        var left_bar = getCookie('left_bar');
        left_bar = base64_decode(left_bar);
        for (var i = left_bar.length - 1; i >= 0; i--) {
            if (left_bar[i] == ']') {
                left_bar = left_bar.substr(0, i + 1);
                break;
            }
        }
        var left_bar = eval('(' + left_bar + ')');
        var str = '';

        for (var i in left_bar) {
            if (typeof(left_bar[i]['son']) != 'undefined') {
                str += '<li><div class="link"><i class="fa ' + left_bar[i]['icon'] + '"></i>' + left_bar[i]['name'] + '<i class="fa fa-chevron-down"></i></div>';
                str += '<ul class="submenu">';
                for (var j in left_bar[i]['son']) {
                    str += '<li><a href="' + left_bar[i]['son'][j]['url'] + '">' + left_bar[i]['son'][j]['name'] + '</a></li>';
                }
                str += '</ul></li>';
            } else {
                str += '<li><a href="' + left_bar[i]['url'] + '" class="left_nav_first"><div class="link"><i class="fa ' + left_bar[i]['icon'] + '"></i>' + left_bar[i]['name'] + '</div></a></ul>';
            }
        }

        $('#accordion').empty();
        $('#accordion').append(str);
    }

    function modifyManager(s_m_id) {
        $('.modify_manager').click(function () {
            var s_realname = $('input[name="s_realname"]').val();
            var system = new Array();
            for (var i = 0; i < $('.select_system').length; i++) {
                if ($('.select_system:eq(' + i + ') select').eq(0).val()) {
                    system[i] = ',';
                    for (var j = 0; j < $('.select_system:eq(' + i + ') select').length; j++) {
                        if ($('.select_system:eq(' + i + ') select').eq(j).val()) {
                            system[i] += $('.select_system:eq(' + i + ') select').eq(j).val() + ',';
                        }
                    }
                    ;
                }
            }
            ;
            infoValidate("teacher_name");
            var wlen=$(".wrong").length;
            var n=typeof($("teacher_name").val());
            if (wlen==0 && n!='undefined') {
                    ajaxPost('/curd_manager/modifyManager', {
                    s_m_id: s_m_id,
                    s_realname: s_realname,
                    system: system
                }, function (Data) {
                    if (Data.flag == 1) {
                        alert('编辑教师信息成功');
                        window.location.href = '/newweb/account_admin.html';
                    }
                });
            } else{
                 alert("请完善信息");
            }
        });
    }


    function modifyManagerPassword(s_m_id) {
        $('.modify_manager_password').click(function () {
            var password = $('input[name="password"]').val();
            var len=password.length;
            if (len>=6) {
                    ajaxPost('/curd_manager/modifyManagerPassword', {s_m_id: s_m_id, password: password}, function (Data) {
                    if (Data.flag == 1) {
                        alert('修改教师密码成功');
                        window.location.href = '/newweb/account_admin.html';
                    }
                });
            } else{
                alert("密码位数应大于6位");
            }
        });
    }


    function cancelModify() {
        $('.cancel').click(function () {
            window.location.href = '/newweb/account_admin.html';
        });
    }

    function clickDelSystem() {
        $(document).on('click', '.del_system', function () {
            $(this).prev().remove();
            $(this).remove();
        })

    }


    function getManagerInfo(s_m_id) {

        ajaxPost('/curd_manager/getManagerInfo', {s_m_id: s_m_id}, function (Data) {
            $('input[name="s_realname"]').val(Data.real_name);
            var systems = Data.system;
            for (var i in systems) {
                var system = systems[i].split(',');
                var status = addNewSystem(system[1]);
                for (var j in system) {
                    if (system[j]) {
                        var count = '';
                        for (var k = 0; k <= i; k++) {
                            count += 1;
                        }
                        ;
                        count = parseInt(count) + (parseInt(j) - 1);

                        change('category_' + count, system[j], system[parseInt(j) + 1]);
                    }
                }
            }
            $('.del_system:first').remove();
        });
    }


    function getFirstSystemForm(id, choose_id) {
        ajaxPost('/pubblico/getNextSystemForm', {parent_id: 0}, function (Data) {
            var data = Data.system_form;
            var str = '';
            for (var i in data) {
                str += '<option value=' + data[i].s_y_f_id + ' ' + (choose_id == data[i].s_y_f_id ? 'selected' : '') + '>' + data[i].s_y_f_name + '</option>';
            }
            $(id).append(str);
        });

    }

    function addNewSystem(choose_id) {
        var system_num = $('.select_system:last').data('id');
        if (isNaN(system_num)) {
            system_num = 0;
        }
        var new_id = '';
        for (var i = 1; i <= system_num; i++) {
            new_id += 1;
        }
        ;
        var str = '<p><div id="select_' + (parseInt(system_num) + 1) + '" data-id="' + (parseInt(system_num) + 1) + '" style="display:inline-block" class="select_system"><select name="category_1' + new_id + '" id="category_1' + new_id + '" onChange="change(\'category_1' + new_id + '\');" class="cap_select block_bcolor_gray system_' + (parseInt(system_num) + 1) + '" style="font-size:18px; border-color:#cfcfcf;"><option value="">请选择</option></select></div><button type="button" class="orange_btn del_system">删除</button></p>';

        $('.system_choose').append(str);
        getFirstSystemForm('#category_1' + new_id, choose_id);
    }

    function clickAddNewSystem() {
        $('.add_system').click(function () {
            addNewSystem();
        });
    }

    function change(val, s_y_f_id, choose_id) {
        var str = val; //select的id
        var select_id = $('#' + str).parent().attr('id');
        var data_id = $('#' + str).parent().data('id');
        var num; //当前级数
        var id; // 分类id
        num = str.substr(9);
        var nownum = parseInt(num) + 1; // 将字符串转换为数字
        if (s_y_f_id) {
            id = s_y_f_id;
        } else {
            id = $("#" + str + "").val();
        }
        var new_id = '';
        for (var i = 1; i <= data_id; i++) {
            new_id += 1;
        }
        ;
        var r = /^[1-9]+[0-9]*]*$/;　//正整数
        if (!r.test(id)) {
            //清空过时的选项
            $(".system_" + data_id).each(function (index) {
                if (index + 1 > num) {
                    $(this).remove();
                }
            })
            return false;
        }
        ajaxPost('/pubblico/getNextSystemForm', {parent_id: id}, function (Data) {
            var result = Data.system_form;
            if (result != 0) {
                var html = "<select name='category_" + nownum + "' id='category_" + nownum + "' class='cap_select block_bcolor_gray system_" + data_id + "' onChange=change('category_" + nownum + "'); style='font-size:18px; border-color:#cfcfcf;'>";
                html += "<option value=''>请选择分类 </option>";
                /*var datas = eval(result);
                 $.each(datas, function (i, val) {
                 html += "<option value='" + val.s_y_f_id + "' "+(val.s_y_f_id==choose_id?'selected':'')+">" + val.s_y_f_name + "</option>";
                 });*/
                for (var i in result) {
                    // console.log(result[i].s_y_f_id);
                    html += "<option value='" + result[i].s_y_f_id + "' " + (result[i].s_y_f_id == choose_id ? 'selected' : '') + ">" + result[i].s_y_f_name + "</option>";
                }
                html += "</select>";
                //清空过时的选项
                $(".system_" + data_id).each(function (index) {
                    /*  console.log(num);
                     console.log(parseInt(new_id)+index+1);*/
                    if (parseInt(new_id) + index > num) {
                        $(this).remove();
                    }
                })
                $("#" + select_id).append(html);
            } else {
                //清空过时的选项
                $(".system_" + data_id).each(function (index) {
                    if (parseInt(new_id) + index > num) {
                        $(this).remove();
                    }
                })
            }
        }, false);
    }

</script>
</html>
